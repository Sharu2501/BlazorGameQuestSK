@page "/"
@inject NavigationManager NavigationManager
@inject IAccessTokenProvider TokenProvider
<link rel="stylesheet" href="css/login.css" />
<div class="login-page-container">
    <div class="login-overlay"></div>
    <div class="login-container">
        <img src="images/logo.png" alt="Logo" class="login-logo" />
        <h3>Connexion</h3>

        <label>Nom d'utilisateur</label>
        <input @bind="Username" placeholder="Utilisateur" />

        <label>Mot de passe</label>
        <div class="password-wrapper">
            <input @bind="Password" placeholder="Mot de passe" type="@PasswordInputType" aria-label="Mot de passe" />
            <div class="eye-container" @onclick="TogglePasswordVisibility" title="@ToggleButtonTitle"
                aria-pressed="@ShowPassword">
                @if (ShowPassword)
                {
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true">
                        <path d="M2 2l20 20" stroke="white" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path
                            d="M17.94 17.94C16.06 19.09 14.06 19.5 12 19.5 7 19.5 3.11 16.36 1.5 12c.83-2.02 2.12-3.77 3.77-5.14"
                            stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9.88 9.88A3 3 0 0 0 14.12 14.12" stroke="white" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                }
                else
                {
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                        aria-hidden="true">
                        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="white" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <circle cx="12" cy="12" r="3" stroke="white" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                }
            </div>
        </div>

        <button @onclick="DoLogin">Se connecter</button>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <p class="error">@ErrorMessage</p>
        }
    </div>
</div>


@code {
    private string Username = "";
    private string Password = "";
    private string ErrorMessage = "";
    private bool ShowPassword = false;
    private string PasswordInputType => ShowPassword ? "text" : "password";
    private string ToggleButtonTitle => ShowPassword ? "Masquer le mot de passe" : "Afficher le mot de passe";

    private void TogglePasswordVisibility()
    {
        ShowPassword = !ShowPassword;
    }

    private async Task DoLogin()
    {
        if (Username.ToLower() == "admin" && Password == "admin")
        {
            NavigationManager.NavigateTo("/admin");
            return;
        }

        try
        {
            var client = new HttpClient();
            var url = "http://localhost:8080/realms/BlazorGame/protocol/openid-connect/token";

            var content = new FormUrlEncodedContent(new[]
            {
            new KeyValuePair<string,string>("grant_type", "password"),
            new KeyValuePair<string,string>("client_id", "blazorgame-client"),
            new KeyValuePair<string, string>("client_secret", "qaF24N6N3hlbfQRDXUpT9ddxSxzdU2HQ"),
            new KeyValuePair<string,string>("username", Username),
            new KeyValuePair<string,string>("password", Password),
            });

            var response = await client.PostAsync(url, content);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<TokenResponse>();
                NavigationManager.NavigateTo("/home");
            }
            else
            {
                ErrorMessage = "Nom d'utilisateur ou mot de passe incorrect.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur : {ex.Message}";
        }
    }

    private class TokenResponse
    {
        public string access_token { get; set; } = "";
        public string refresh_token { get; set; } = "";
        public string token_type { get; set; } = "";
        public int expires_in { get; set; }
    }
}