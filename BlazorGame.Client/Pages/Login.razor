@page "/"
@using BlazorGame.Client.Services
@inject NavigationManager NavigationManager
@inject IAccessTokenProvider TokenProvider
@inject HttpClient Http
@inject AuthService AuthService
<link rel="stylesheet" href="css/login.css" />
<div class="login-page-container">
    <div class="login-overlay"></div>
    <div class="login-container">
        <img src="images/logo.png" alt="Logo" class="login-logo" />
        <h3>Connexion</h3>

        <label>Nom d'utilisateur</label>
        <input @bind="Username" placeholder="Utilisateur" />

        <label>Mot de passe</label>
        <div class="password-wrapper">
            <input @bind="Password" placeholder="Mot de passe" type="@PasswordInputType" aria-label="Mot de passe" />
            <div class="eye-container" @onclick="TogglePasswordVisibility" title="@ToggleButtonTitle"
                 aria-pressed="@ShowPassword">
                @if (ShowPassword)
                {
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                         aria-hidden="true">
                        <path d="M2 2l20 20" stroke="white" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round" />
                        <path
                            d="M17.94 17.94C16.06 19.09 14.06 19.5 12 19.5 7 19.5 3.11 16.36 1.5 12c.83-2.02 2.12-3.77 3.77-5.14"
                            stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9.88 9.88A3 3 0 0 0 14.12 14.12" stroke="white" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round" />
                    </svg>
                }
                else
                {
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                         aria-hidden="true">
                        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="white" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round" />
                        <circle cx="12" cy="12" r="3" stroke="white" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                    </svg>
                }
            </div>
        </div>

        <button @onclick="DoLogin">Se connecter</button>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <p class="error">@ErrorMessage</p>
        }
    </div>
</div>


@code {
    private string Username = "";
    private string Password = "";
    private string ErrorMessage = "";
    private bool ShowPassword = false;
    private string PasswordInputType => ShowPassword ? "text" : "password";
    private string ToggleButtonTitle => ShowPassword ? "Masquer le mot de passe" : "Afficher le mot de passe";

    private void TogglePasswordVisibility()
    {
        ShowPassword = !ShowPassword;
    }

    private async Task DoLogin()
    {
        if (Username.ToLower() == "admin" && Password == "admin")
        {
            NavigationManager.NavigateTo("/admin");
            return;
        }

        if (!string.IsNullOrWhiteSpace(Username) && !string.IsNullOrWhiteSpace(Password))
        {
            try
            {
                var players = await Http.GetFromJsonAsync<List<Player>>("http://localhost:5240/api/Player");
                var player = players?.FirstOrDefault(p => p.Username.ToLower() == Username.ToLower());

                if (player == null)
                {
                    player = new Player
                    {
                        Username = Username,
                        Email = $"{Username}@game.com",
                        PasswordHash = Password,
                        UserType = SharedModels.Enum.UserTypeEnum.PLAYER,
                        Level = 1,
                        Health = 100,
                        MaxHealth = 100,
                        Attack = 10,
                        Defense = 5,
                        Gold = 0,
                        ExperiencePoints = 0,
                        LevelCap = 100
                    };

                    var response = await Http.PostAsJsonAsync("http://localhost:5240/api/Player", player);
                    player = await response.Content.ReadFromJsonAsync<Player>();
                }

                if (player != null)
                {
                    AuthService.Login(player.Id, player.Username);
                    NavigationManager.NavigateTo("/home");
                }
                else
                {
                    ErrorMessage = "Erreur lors de la connexion.";
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Erreur : {ex.Message}";
            }
        }
        else
        {
            ErrorMessage = "Veuillez remplir tous les champs.";
        }
    }
}