@page "/"
@using BlazorGame.Client.Services
@using System.IdentityModel.Tokens.Jwt;
@using System.Net.Http.Headers;
@using System.Text.Json;
@using SharedModels.Model;
@using SharedModels.Enum;

@inject NavigationManager NavigationManager
@inject IAccessTokenProvider TokenProvider
@inject HttpClient Http
@inject AuthService AuthService

<link rel="stylesheet" href="css/Login.css" />
<div class="login-page-container">
    <div class="login-overlay"></div>
    <div class="login-container">
        <img src="images/logo.png" alt="Logo" class="login-logo" />
        <h3>Connexion</h3>

        <label>Nom d'utilisateur</label>
        <input @bind="Username" placeholder="Utilisateur" />

        <label>Mot de passe</label>
        <div class="password-wrapper">
            <input @bind="Password" placeholder="Mot de passe" type="@PasswordInputType" aria-label="Mot de passe" />
            <div class="eye-container" @onclick="TogglePasswordVisibility" title="@ToggleButtonTitle"
                 aria-pressed="@ShowPassword">
                @if (ShowPassword)
                {
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                         aria-hidden="true">
                        <path d="M2 2l20 20" stroke="white" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round" />
                        <path d="M17.94 17.94C16.06 19.09 14.06 19.5 12 19.5 7 19.5 3.11 16.36 1.5 12c.83-2.02 2.12-3.77 3.77-5.14"
                              stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9.88 9.88A3 3 0 0 0 14.12 14.12" stroke="white" stroke-width="2" stroke-linecap="round"
                              stroke-linejoin="round" />
                    </svg>
                }
                else
                {
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                         aria-hidden="true">
                        <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke="white" stroke-width="2"
                              stroke-linecap="round" stroke-linejoin="round" />
                        <circle cx="12" cy="12" r="3" stroke="white" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                    </svg>
                }
            </div>
        </div>

        <button @onclick="DoLogin">Se connecter</button>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <p class="error">@ErrorMessage</p>
        }
    </div>
</div>

@code {
    private string Username = "";
    private string Password = "";
    private string ErrorMessage = "";
    private bool ShowPassword = false;
    private string PasswordInputType => ShowPassword ? "text" : "password";
    private string ToggleButtonTitle => ShowPassword ? "Masquer le mot de passe" : "Afficher le mot de passe";

    private void TogglePasswordVisibility()
    {
        ShowPassword = !ShowPassword;
    }

    private async Task DoLogin()
    {
        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(Password))
        {
            ErrorMessage = "Veuillez remplir tous les champs.";
            return;
        }

        try
        {
            var client = new HttpClient();
            // Assurez-vous que l'URL correspond à votre configuration Docker/Keycloak
            var url = "http://localhost:8080/realms/BlazorGame/protocol/openid-connect/token";

            var content = new FormUrlEncodedContent(new[]
            {
                new KeyValuePair<string,string>("grant_type", "password"),
                new KeyValuePair<string,string>("client_id", "blazorgame-client"),
                // Vérifiez que le client_secret est correct ou nécessaire selon votre config Keycloak
                new KeyValuePair<string,string>("client_secret", "LLZ17mtIRlhtLdh3avIeY9zch4WjAxtF"),
                new KeyValuePair<string,string>("username", Username),
                new KeyValuePair<string,string>("password", Password),
            });

            var response = await client.PostAsync(url, content);

            if (!response.IsSuccessStatusCode)
            {
                ErrorMessage = "Nom d'utilisateur ou mot de passe incorrect.";
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<TokenResponse>();
            var accessToken = result!.access_token;

            // 1. Analyse du Token pour voir si c'est un Admin Keycloak
            var handler = new JwtSecurityTokenHandler();
            var jwt = handler.ReadJwtToken(accessToken);
            var resourceAccessClaim = jwt.Claims.FirstOrDefault(c => c.Type == "resource_access")?.Value;
            var isAdmin = false;

            if (!string.IsNullOrEmpty(resourceAccessClaim))
            {
                using var doc = JsonDocument.Parse(resourceAccessClaim);
                if (doc.RootElement.TryGetProperty("blazorgame-client", out var clientObj) &&
                    clientObj.TryGetProperty("roles", out var rolesArray))
                {
                    foreach (var r in rolesArray.EnumerateArray())
                    {
                        if (string.Equals(r.GetString(), "Administrateur", StringComparison.OrdinalIgnoreCase))
                        {
                            isAdmin = true;
                            break;
                        }
                    }
                }
            }

            var keycloakId = jwt.Claims.FirstOrDefault(c => c.Type == "sub")?.Value;
            var username = jwt.Claims.FirstOrDefault(c => c.Type == "preferred_username")?.Value ?? Username;
            var email = jwt.Claims.FirstOrDefault(c => c.Type == "email")?.Value ?? $"{username}@blazorgamesk.com";

            // 2. Récupération ou Création du joueur via l'API
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);
            var players = await Http.GetFromJsonAsync<List<Player>>("http://localhost:5240/api/Player");
            
            var player = players?.FirstOrDefault(p =>
                p.ExternalId == keycloakId || p.Username.ToLower() == username.ToLower());

            // Création si nouveau joueur
            if (player == null)
            {
                player = new Player
                {
                    Username = username,
                    Email = email,
                    ExternalId = keycloakId,
                    PasswordHash = Password,
                    // ICI : On assigne le rôle en fonction de Keycloak
                    UserType = isAdmin ? UserTypeEnum.ADMIN : UserTypeEnum.PLAYER,
                    IsActive = true, // Par défaut, un nouveau compte est actif
                    Level = 1,
                    Health = 100,
                    MaxHealth = 100,
                    Attack = 10,
                    Defense = 5,
                    Gold = 0,
                    ExperiencePoints = 0,
                    LevelCap = 100
                };

                var createResponse = await Http.PostAsJsonAsync("http://localhost:5240/api/Player", player);
                if (createResponse.IsSuccessStatusCode)
                {
                    player = await createResponse.Content.ReadFromJsonAsync<Player>();
                }
                else
                {
                    ErrorMessage = "Erreur lors de la création du profil.";
                    return;
                }
            }

            // 3. Vérification finale et Redirection
            if (player != null)
            {
                if (!player.IsActive)
                {
                    ErrorMessage = "Votre compte a été désactivé. Veuillez contacter l'administrateur.";
                    return; // On arrête tout, pas de login.
                }
                if(player.IsActive){
                AuthService.Login(player.Id, player.Username, accessToken);

                if (isAdmin)
                    NavigationManager.NavigateTo("/admin");
                else
                    NavigationManager.NavigateTo("/home");
                    }
            }
            else
            {
                ErrorMessage = "Erreur lors de la récupération du profil joueur.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erreur technique : {ex.Message}";
        }
    }

    private class TokenResponse
    {
        public string access_token { get; set; } = "";
        public string refresh_token { get; set; } = "";
        public string token_type { get; set; } = "";
        public int expires_in { get; set; }
    }
}