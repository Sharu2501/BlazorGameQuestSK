@page "/game"
@using BlazorGame.Client.Services
@using SharedModels.Enum
@inject HttpClient Http
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<link rel="stylesheet" href="css/room.css" />

@if (isLoading)
{
    <div class="loading-container">
        <p>G√©n√©ration du donjon...</p>
    </div>
}
else if (gameState != null)
{
    <div class="salle-container" style="background-image: url('@GetRoomImage()')">
        <div class="salle-content">
            <img src="images/logo.png" class="room-logo" />
            
            <div class="dungeon-info">
                <h2>@gameState.CurrentDungeon?.Name</h2>
                <p class="dungeon-desc">@gameState.CurrentDungeon?.Description</p>
                <p>Salle @(gameState.CurrentRoomIndex + 1) / @gameState.TotalRooms</p>
                <p>Difficult√©: @GetDifficultyName(gameState.DifficultyLevel)</p>
            </div>

            <h3>@gameState.CurrentRoom?.Name</h3>
            <p>@gameState.CurrentRoom?.Description</p>
            
            @if (gameState.CurrentRoom?.Monster != null && !gameState.IsMonsterDefeated)
            {
                <div class="monster-info">
                    <h4>‚öîÔ∏è @gameState.CurrentRoom.Monster.Name (Niveau @gameState.CurrentRoom.Monster.Level)</h4>
                    <div class="monster-stats">
                        <span>‚ù§Ô∏è PV: @gameState.CurrentRoom.Monster.Health</span>
                        <span>‚öîÔ∏è ATQ: @gameState.CurrentRoom.Monster.Attack</span>
                        <span>üõ°Ô∏è DEF: @gameState.CurrentRoom.Monster.Defense</span>
                    </div>
                </div>
            }
            
            <div class="actions">
                @foreach (var action in GetAvailableActions())
                {
                    <button @onclick="@(() => ExecuteAction(action))" disabled="@IsActionDisabled(action)">@action</button>
                }
            </div>

            <div class="heal-potions">
                <span>üß™ Potions de soin: </span>
                @for (int i = 0; i < gameState.MaxHealPerRoom; i++)
                {
                    @if (i < gameState.HealUsedInRoom)
                    {
                        <span class="potion-used">‚ö´</span>
                    }
                    else
                    {
                        <span class="potion-available">üü¢</span>
                    }
                }
            </div>
            
            <p class="message">@message</p>
            
            <div class="player-stats">
                <h4>üìä Statistiques de @PlayerStats?.Username</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">‚ù§Ô∏è PV:</span>
                        <span class="stat-value">@PlayerStats?.Health / @PlayerStats?.MaxHealth</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">‚öîÔ∏è ATQ:</span>
                        <span class="stat-value">@PlayerStats?.Attack</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üõ°Ô∏è DEF:</span>
                        <span class="stat-value">@PlayerStats?.Defense</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üí∞ Or:</span>
                        <span class="stat-value">@PlayerStats?.Gold</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">‚≠ê Score:</span>
                        <span class="stat-value">@gameState.Score</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üìà Niveau:</span>
                        <span class="stat-value">@PlayerStats?.Level</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<style>
.heal-potions {
    margin: 1rem 0;
    font-size: 1.2rem;
    color: white;
}

.potion-available {
    margin: 0 0.2rem;
    font-size: 1.5rem;
}

.potion-used {
    margin: 0 0.2rem;
    font-size: 1.5rem;
    opacity: 0.3;
}

.loading-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: white;
    font-size: 2rem;
}

.dungeon-info {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
}

.dungeon-desc {
    font-style: italic;
    opacity: 0.9;
}
</style>

@code {
    [SupplyParameterFromQuery]
    public int Difficulty { get; set; } = 0;

    private class GameState
    {
        public Dungeon? CurrentDungeon { get; set; }
        public Room? CurrentRoom { get; set; }
        public int CurrentRoomIndex { get; set; }
        public int TotalRooms { get; set; }
        public bool IsMonsterDefeated { get; set; }
        public bool IsRoomCompleted { get; set; }
        public int Score { get; set; }
        public int SessionId { get; set; }
        public int HealUsedInRoom { get; set; }
        public int MaxHealPerRoom { get; set; } = 2;
        public DifficultyLevelEnum DifficultyLevel { get; set; }
    }

    private GameState? gameState;
    private PlayerStatsDto? PlayerStats;
    private string message = "";
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated || !AuthService.CurrentPlayerId.HasValue)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        await InitializeGame();
    }

    private async Task InitializeGame()
    {
        try
        {
            PlayerStats = await Http.GetFromJsonAsync<PlayerStatsDto>(
                $"http://localhost:5240/api/Player/{AuthService.CurrentPlayerId.Value}/stats"
            );

            var difficultyLevel = (DifficultyLevelEnum)Difficulty;

            var dungeonResponse = await Http.PostAsJsonAsync(
                "http://localhost:5240/api/Dungeon/generate",
                new { numberOfRooms = 5, level = PlayerStats.Level, difficulty = Difficulty }
            );
            var dungeon = await dungeonResponse.Content.ReadFromJsonAsync<Dungeon>();

            var sessionResponse = await Http.PostAsJsonAsync(
                "http://localhost:5240/api/GameSession/start",
                new { PlayerId = AuthService.CurrentPlayerId.Value, DungeonId = dungeon.IdDungeon }
            );
            var session = await sessionResponse.Content.ReadFromJsonAsync<GameSession>();

            gameState = new GameState
            {
                CurrentDungeon = dungeon,
                CurrentRoom = dungeon.Rooms?.FirstOrDefault(),
                CurrentRoomIndex = 0,
                TotalRooms = dungeon.Rooms?.Count ?? 0,
                IsMonsterDefeated = false,
                IsRoomCompleted = false,
                Score = 0,
                SessionId = session.SessionId,
                HealUsedInRoom = 0,
                DifficultyLevel = difficultyLevel
            };

            message = "Vous entrez dans le donjon...";
            isLoading = false;
        }
        catch (Exception ex)
        {
            message = $"Erreur lors de l'initialisation: {ex.Message}";
            isLoading = false;
        }
    }

    private List<string> GetAvailableActions()
    {
        var actions = new List<string>();

        if (gameState == null || gameState.CurrentRoom == null)
            return actions;

        if (gameState.CurrentRoom.Monster != null && !gameState.IsMonsterDefeated)
        {
            actions.Add("Attaquer");
            actions.Add("D√©fendre");
            actions.Add("Soigner");
            actions.Add("Fuir");
        }
        else if (!gameState.IsRoomCompleted)
        {
            actions.Add("Fouiller");
        }
        else
        {
            if (gameState.CurrentRoomIndex < gameState.TotalRooms - 1)
            {
                actions.Add("Salle suivante");
            }
            else
            {
                actions.Add("Terminer le donjon");
            }
        }

        return actions;
    }

    private bool IsActionDisabled(string action)
    {
        if (action == "Soigner" && gameState.HealUsedInRoom >= gameState.MaxHealPerRoom)
        {
            return true;
        }
        return false;
    }

    private async Task ExecuteAction(string action)
    {
        if (gameState == null || gameState.CurrentRoom == null || !AuthService.CurrentPlayerId.HasValue)
            return;

        var playerId = AuthService.CurrentPlayerId.Value;

        try
        {
            switch (action)
            {
                case "Attaquer":
                    await AttackMonster(playerId);
                    break;
                case "D√©fendre":
                    await Defend(playerId);
                    break;
                case "Soigner":
                    await Heal(playerId);
                    break;
                case "Fuir":
                    await Flee(playerId);
                    break;
                case "Fouiller":
                    await SearchRoom(playerId);
                    break;
                case "Salle suivante":
                    await NextRoom();
                    break;
                case "Terminer le donjon":
                    await CompleteDungeon();
                    break;
            }

            PlayerStats = await Http.GetFromJsonAsync<PlayerStatsDto>(
                $"http://localhost:5240/api/Player/{playerId}/stats"
            );

            if (PlayerStats?.Health <= 0)
            {
                await GameOver();
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            message = $"Erreur: {ex.Message}";
        }
    }

    private async Task AttackMonster(int playerId)
    {
        if (gameState?.CurrentRoom?.Monster == null)
            return;

        var response = await Http.PostAsJsonAsync("http://localhost:5240/api/Combat/attack",
            new { playerId, monsterId = gameState.CurrentRoom.Monster.IdMonster });

        var result = await response.Content.ReadFromJsonAsync<AttackResult>();

        if (result == null || !result.Success)
        {
            message = "Erreur lors de l'attaque";
            return;
        }

        if (!result.Hit)
        {
            message = result.Message;
            
            if (gameState.CurrentRoom.Monster != null)
            {
                var monsterResponse = await Http.PostAsJsonAsync("http://localhost:5240/api/Combat/monster-attack",
                    new { monsterId = gameState.CurrentRoom.Monster.IdMonster, playerId });
                var monsterResult = await monsterResponse.Content.ReadFromJsonAsync<AttackResult>();
                
                if (monsterResult != null && monsterResult.Hit)
                {
                    message += $"\n{monsterResult.Message}";
                }
                else if (monsterResult != null)
                {
                    message += $"\n{monsterResult.Message}";
                }
            }
            return;
        }

        var updatedMonster = await Http.GetFromJsonAsync<Monster>(
            $"http://localhost:5240/api/Monster/{gameState.CurrentRoom.Monster.IdMonster}"
        );

        if (updatedMonster.Health <= 0)
        {
            gameState.IsMonsterDefeated = true;
            
            int roomScore = CalculateRoomScore();
            gameState.Score += roomScore;
            
            message = $"{result.Message}\nVous avez vaincu {updatedMonster.Name} ! +{roomScore} points";
            
            await Http.PostAsJsonAsync($"http://localhost:5240/api/Combat/victory",
                new { playerId, roomId = gameState.CurrentRoom.Id });
        }
        else
        {
            message = $"{result.Message}\n{updatedMonster.Name} a encore {updatedMonster.Health} PV.";
            gameState.CurrentRoom.Monster = updatedMonster;
            
            var monsterResponse = await Http.PostAsJsonAsync("http://localhost:5240/api/Combat/monster-attack",
                new { monsterId = updatedMonster.IdMonster, playerId });
            var monsterResult = await monsterResponse.Content.ReadFromJsonAsync<AttackResult>();
            
            if (monsterResult != null)
            {
                message += $"\n{monsterResult.Message}";
            }
        }
    }

    private async Task Defend(int playerId)
    {
        await Http.PostAsJsonAsync("http://localhost:5240/api/Combat/defend", new { playerId });
        message = "Vous vous mettez en position d√©fensive.";
    }

    private async Task Heal(int playerId)
    {
        if (gameState.HealUsedInRoom >= gameState.MaxHealPerRoom)
        {
            message = "Vous n'avez plus de potions de soin pour cette salle !";
            return;
        }

        await Http.PostAsJsonAsync($"http://localhost:5240/api/Player/{playerId}/heal", 20);
        gameState.HealUsedInRoom++;
        message = "Vous utilisez une potion de soin. +20 PV";
    }

    private async Task Flee(int playerId)
    {
        var response = await Http.PostAsJsonAsync("http://localhost:5240/api/Combat/flee", new { playerId });
        bool success = await response.Content.ReadFromJsonAsync<bool>();
        
        if (success)
        {
            message = "Vous fuyez la salle avec succ√®s !";
            gameState.IsMonsterDefeated = true;
            gameState.IsRoomCompleted = true;
        }
        else
        {
            message = "√âchec de la fuite ! Le monstre vous rattrape.";
            if (gameState?.CurrentRoom?.Monster != null)
            {
                var monsterResponse = await Http.PostAsJsonAsync("http://localhost:5240/api/Combat/monster-attack",
                    new { monsterId = gameState.CurrentRoom.Monster.IdMonster, playerId });
                var monsterResult = await monsterResponse.Content.ReadFromJsonAsync<AttackResult>();
                
                if (monsterResult != null)
                {
                    message += $"\n{monsterResult.Message}";
                }
            }
        }
    }

    private async Task SearchRoom(int playerId)
    {
        var random = new Random();
        int goldFound = random.Next(10, 50) * (PlayerStats?.Level ?? 1);
        
        await Http.PostAsJsonAsync($"http://localhost:5240/api/Player/{playerId}/add-gold", goldFound);
        
        int roomScore = CalculateRoomScore() / 2;
        gameState.Score += roomScore;
        
        message = $"Vous fouillez la salle et trouvez {goldFound} pi√®ces d'or ! +{roomScore} points";
        gameState.IsRoomCompleted = true;
    }

    private async Task NextRoom()
    {
        if (gameState == null || gameState.CurrentDungeon?.Rooms == null)
            return;

        gameState.CurrentRoomIndex++;
        if (gameState.CurrentRoomIndex < gameState.TotalRooms)
        {
            gameState.CurrentRoom = gameState.CurrentDungeon.Rooms[gameState.CurrentRoomIndex];
            gameState.IsMonsterDefeated = false;
            gameState.IsRoomCompleted = false;
            gameState.HealUsedInRoom = 0;
            message = $"Vous entrez dans la salle {gameState.CurrentRoomIndex + 1}...";
        }
    }

    private async Task CompleteDungeon()
    {
        if (!AuthService.CurrentPlayerId.HasValue || gameState == null)
            return;

        var playerId = AuthService.CurrentPlayerId.Value;
        
        int completionBonus = CalculateDungeonBonus();
        gameState.Score += completionBonus;
        
        await Http.PostAsJsonAsync("http://localhost:5240/api/HighScore/update",
            new { playerId, score = gameState.Score });
        
        await Http.PostAsJsonAsync("http://localhost:5240/api/GameHistory", new 
        { 
            playerId, 
            dungeonIds = new[] { gameState.CurrentDungeon?.IdDungeon } 
        });
        
        await Http.PostAsJsonAsync($"http://localhost:5240/api/GameSession/end/{gameState.SessionId}", new { });
        
        NavigationManager.NavigateTo($"/game-over?score={gameState.Score}&success=true");
    }

    private async Task GameOver()
    {
        if (!AuthService.CurrentPlayerId.HasValue || gameState == null)
            return;

        await Http.PostAsJsonAsync("http://localhost:5240/api/HighScore/update",
            new { playerId = AuthService.CurrentPlayerId.Value, score = gameState.Score });
        
        await Http.PostAsJsonAsync($"http://localhost:5240/api/GameSession/end/{gameState.SessionId}", new { });
        
        NavigationManager.NavigateTo($"/game-over?score={gameState.Score}&success=false");
    }

    private int CalculateRoomScore()
    {
        if (gameState == null)
            return 0;

        int baseScore = 100;
        
        double difficultyMultiplier = gameState.DifficultyLevel switch
        {
            DifficultyLevelEnum.EASY => 1.0,
            DifficultyLevelEnum.MEDIUM => 1.5,
            DifficultyLevelEnum.HARD => 2.0,
            DifficultyLevelEnum.EXTREME => 3.0,
            _ => 1.0
        };

        return (int)(baseScore * difficultyMultiplier * (PlayerStats?.Level ?? 1));
    }

    private int CalculateDungeonBonus()
    {
        if (gameState == null)
            return 0;

        int baseBonus = 500;
        
        double difficultyMultiplier = gameState.DifficultyLevel switch
        {
            DifficultyLevelEnum.EASY => 1.0,
            DifficultyLevelEnum.MEDIUM => 1.5,
            DifficultyLevelEnum.HARD => 2.0,
            DifficultyLevelEnum.EXTREME => 3.0,
            _ => 1.0
        };

        return (int)(baseBonus * difficultyMultiplier * (PlayerStats?.Level ?? 1));
    }

    private string GetRoomImage()
    {
        if (gameState?.CurrentRoom == null)
            return "images/room1.jpg";
        
        var images = new[] { "images/room1.jpg", "images/room2.jpg" };
        return images[gameState.CurrentRoomIndex % images.Length];
    }

    private string GetDifficultyName(DifficultyLevelEnum difficulty)
    {
        return difficulty switch
        {
            DifficultyLevelEnum.EASY => "Facile",
            DifficultyLevelEnum.MEDIUM => "Moyen",
            DifficultyLevelEnum.HARD => "Difficile",
            DifficultyLevelEnum.EXTREME => "Extr√™me",
            _ => "Inconnu"
        };
    }

    public class AttackResult
    {
        public bool Success { get; set; }
        public bool Hit { get; set; }
        public int Damage { get; set; }
        public int MonsterHealth { get; set; }
        public int PlayerHealth { get; set; }
        public string Message { get; set; } = string.Empty;
    }
}