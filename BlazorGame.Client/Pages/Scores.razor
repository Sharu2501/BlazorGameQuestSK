@page "/scores"
@using BlazorGame.Client.Services
@inject HttpClient Http
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<link rel="stylesheet" href="css/scores.css" />
<div class="scores-page-container">
    <div class="background-overlay"></div>
    <div class="scores-container">
        <img src="images/logo.png" alt="Logo" class="scores-logo" />
        <h3>Mes Scores et Historique</h3>

        @if (isLoading)
        {
            <p>Chargement...</p>
        }
        else
        {
            <section class="scores-section">
                <h4>Mes Meilleurs Scores</h4>
                @if (highScores != null && highScores.Any())
                {
                    <table class="scores-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Score</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (score, index) in highScores.Select((s, i) => (s, i)))
                            {
                                <tr>
                                    <td>@(index + 1)</td>
                                    <td>@score.Score</td>
                                    <td>@score.DateAchieved.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>Aucun score enregistré.</p>
                }
            </section>

            <section class="history-section">
                <h4>Historique des Parties</h4>
                @if (gameHistories != null && gameHistories.Any())
                {
                    @foreach (var history in gameHistories)
                    {
                        <div class="history-card">
                            <p><strong>Date :</strong> @history.DatePlayed.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                            <p><strong>Donjons complétés :</strong> @history.CompletedDungeons.Count</p>
                            @if (history.CompletedDungeons.Any())
                            {
                                <ul>
                                    @foreach (var dungeon in history.CompletedDungeons)
                                    {
                                        <li>@dungeon.Name - @dungeon.Description</li>
                                    }
                                </ul>
                            }
                            <p><strong>Score :</strong> @history.Score</p>
                        
                        </div>
                    }
                }
                else
                {
                    <p>Aucune partie jouée.</p>
                }
            </section>
        }
    </div>
</div>

@code {
    private List<HighScore> highScores = new();
    private List<GameHistory> gameHistories = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated || !AuthService.CurrentPlayerId.HasValue)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var playerId = AuthService.CurrentPlayerId.Value;

            var playerStats = await Http.GetFromJsonAsync<PlayerStatsDto>($"http://localhost:5240/api/Player/{playerId}/stats");
            
            if (playerStats != null && playerStats.HighestScore > 0)
            {
                highScores = new List<HighScore>
                {
                    new HighScore
                    {
                        Score = playerStats.HighestScore,
                        DateAchieved = playerStats.HighScoreDate ?? DateTime.UtcNow
                    }
                };
            }

            gameHistories = await Http.GetFromJsonAsync<List<GameHistory>>($"http://localhost:5240/api/GameHistory/Player/{playerId}") ?? new List<GameHistory>();

            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur: {ex.Message}");
            isLoading = false;
        }
    }
}