@page "/room1"
@inject HttpClient Http
<link rel="stylesheet" href="css/room.css" />
<div class="salle-container" style="background-image: url('@CurrentRoomImage')">
    <div class="salle-content">
        <img src="images/logo.png" class="room-logo" />
        <h3>@CurrentRoom?.Name</h3>
        <p>@CurrentRoom?.Description</p>
        @if (CurrentRoom?.Monster != null)
        {
            <p>Monstre: @CurrentRoom.Monster.Name</p>
        }
        <div class="actions">
            @foreach (var action in PossibleActions)
            {
                <button @onclick="@(() => DoAction(action))">@action</button>
            }
        </div>
        <p class="message">@message</p>
        <div>
            <b>Stat joueur :</b>
            <ul>
                <li>PV : @PlayerStats?.Health / @PlayerStats?.MaxHealth</li>
                <li>ATQ : @PlayerStats?.Attack</li>
                <li>DEF : @PlayerStats?.Defense</li>
                <li>Or : @PlayerStats?.Gold</li>
            </ul>
        </div>
    </div>
</div>

@code {
    Room? CurrentRoom;
    string message = "Salle générée.";

    PlayerStatsDto? PlayerStats;
    List<string> PossibleActions = new();
    string CurrentRoomImage = "images/room1.jpg";

    protected override async Task OnInitializedAsync() 
    {
        var playerId = 1;

        PlayerStats = await Http.GetFromJsonAsync<PlayerStatsDto>($"http://localhost:5240/api/Player/{playerId}/stats");
        CurrentRoom = await Http.GetFromJsonAsync<Room>($"http://localhost:5240/api/Room/generate?level={PlayerStats.Level}&difficulty=0");

        //CurrentRoomImage = $"images/{CurrentRoom.Name.Replace(" ","_").ToLower()}.png";

        PossibleActions.Clear();
        if (CurrentRoom.Monster != null)
        {
            PossibleActions.Add("Combattre");
            PossibleActions.Add("Fuir");
        }
        PossibleActions.Add("Fouiller");
    }

    async Task DoAction(string action)
    {
        var playerId = 1;

        switch(action)
        {
            case "Combattre":
                await Http.PostAsJsonAsync($"http://localhost:5240/api/Combat/attack", new { playerId, monsterId = CurrentRoom.Monster.IdMonster });
                message = "Vous attaquez le monstre.";
                PlayerStats = await Http.GetFromJsonAsync<PlayerStatsDto>($"http://localhost:5240/api/Player/{playerId}/stats");
                break;
            case "Fuir":
                var response = await Http.PostAsJsonAsync($"http://localhost:5240/api/Combat/flee", new { playerId });
                bool flee = await response.Content.ReadFromJsonAsync<bool>();
                message = flee ? "Vous fuyez la salle." : "Échec ! Le monstre vous rattrape.";
                PlayerStats = await Http.GetFromJsonAsync<PlayerStatsDto>($"http://localhost:5240/api/Player/{playerId}/stats");
                break;
            case "Fouiller":
                message = "Vous fouillez la salle.";
                PlayerStats = await Http.GetFromJsonAsync<PlayerStatsDto>($"http://localhost:5240/api/Player/{playerId}/stats");
                break;
        }
        StateHasChanged();
    }
}